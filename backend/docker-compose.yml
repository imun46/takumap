version: "3.8"
services:
  # 1. MySQL 컨테이너 서비스 정의
  mysql:
    image: mysql:8.0				# 사용할 MySQL 버전 이미지
    container_name: otaku_map_mysql # 컨테이너 이름
    
    # 환경 변수 설정 (Spring Boot의 application.properties와 일치해야 함)
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: otaku_map_db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      TZ: Asia/Seoul 			     # 시간대 설정
    ports:
      - "3306:3306" 			     # 호스트(로컬)의 3306 포트와 컨테이너의 3306 포트 연결
    volumes:
    
      # DB 데이터가 컨테이너 재시작/삭제 시에도 유지되도록 볼륨 설정
      - mysql_data:/var/lib/mysql 
    command: 
      - --character-set-server=utf8mb4 
      - --collation-server=utf8mb4_unicode_ci 
      
  backend:
    build: 
      context: . 					# 현재 폴더(backend)를 빌드 컨텍스트로 사용
      dockerfile: Dockerfile # backend 폴더의 Dockerfile 사용
    container_name: otaku_map_backend
    ports:
      - "8080:8080"
      
    # MySQL이 먼저 시작되어야 하므로 의존성 설정
    depends_on:
      - mysql
    environment:
    
      # DB 접속 정보는 반드시 환경 변수로 전달해야 컨테이너 간 통신이 됩니다.
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/otaku_map_db?serverTimezone=UTC&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password

	# 볼륨 정의 (데이터 영구 저장을 위함)
	volumes:
	  mysql_data: